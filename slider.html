<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sescibaba Akıllı Slider</title>

<style>
body { margin:0; padding:0; background:#fff; font-family:Arial; }

.slider-wrap { overflow:hidden; width:100%; max-width:1850px; margin:0 auto; position:relative; }
.slider-track { display:flex; gap:18px; transition:transform .5s; }

.slide-item { width:150px; text-align:center; padding:20px 0; }
.slide-item img { width:150px; height:150px; object-fit:contain; border-radius:12px; }

.product-title { font-size:14px; font-weight:700; margin-top:10px; }

.product-price { font-size:15px; font-weight:800; color:#d30000; margin-top:4px; }

.out-stock {
  font-size:12px;
  color:#cc5555;
  font-weight:600;
  margin-top:6px;
  opacity:0.85;
}

.add-cart-btn {
  margin-top:6px;
  background:#28a745;
  color:#fff;
  border:0;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
}

.slider-arrow {
  position:absolute; top:45%; transform:translateY(-50%);
  background:#fff; border:0; width:40px; height:40px; border-radius:50%;
  box-shadow:0 0 6px rgba(0,0,0,.25);
  cursor:pointer; font-size:22px;
}

.slider-prev { left:5px; }
.slider-next { right:5px; }

.slider-divider {
  width:92%; height:2px; background:rgba(0,0,0,.15);
  margin:10px auto 40px;
}
</style>

</head>
<body>

<div class="slider-wrap">
  <button class="slider-arrow slider-prev">❮</button>
  <div class="slider-track" id="sliderTrack"></div>
  <button class="slider-arrow slider-next">❯</button>
</div>

<div class="slider-divider"></div>

<script>

function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement("script");
    s.src = src+"?v="+Date.now();
    s.onload=resolve;
    s.onerror=reject;
    document.body.appendChild(s);
  });
}

const getParam = key => new URLSearchParams(location.search).get(key);

// ✔ TL – USD – EUR fiyat düzeltme fonksiyonu
function formatPrice(p){
    if (!p) return "";

    const price = p.replace(/[^0-9.,]/g,"").trim();

    // TRY (siteden gelen default)
    return "₺" + price;
}

async function loadSlider(){
    const CAT = getParam("cat") || "CAT001";

    await loadScript("data/category-map.js");
    await loadScript("data/products.js");

    const related = window.CATEGORY_MAP[CAT].related;
    const products = window.PRODUCTS;
    const track = document.getElementById("sliderTrack");

    for (let rc of related) {
        const link = products[rc]?.[0];
        if (!link) continue;

        const api = await fetch(
          "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url="+encodeURIComponent(link)
        ).then(r=>r.json());

        const div = document.createElement("div");
        div.className = "slide-item";

        let bottomHTML = "";

        if (api.stock === "YOK") {
            bottomHTML = `<div class='out-stock'>Tükendi</div>`;
        } else {
            bottomHTML = `
                <div class="product-price">${formatPrice(api.price)}</div>
                <button class='add-cart-btn' onclick="addToCart('${link}')">Sepete Ekle</button>
            `;
        }

        div.innerHTML = `
            <a href="${link}" target="_top"><img src="${api.image}"></a>
            <div class="product-title">${api.title}</div>
            ${bottomHTML}
        `;

        track.appendChild(div);
    }

    initSlider();
}

// Sepete ekle → iframe içinde çalışır
function addToCart(link){
    window.top.location.href = link + "?add-to-cart=1";
}

function initSlider(){
    const track = document.getElementById("sliderTrack");
    const slides = [...track.children];
    let index=0, slideWidth = 168;

    function go(i){ track.style.transform = "translateX(-"+(i*slideWidth)+"px)"; }

    document.querySelector(".slider-next").onclick = ()=>{
        index++; if(index >= slides.length-8) index=0; go(index);
    };
    document.querySelector(".slider-prev").onclick = ()=>{
        index--; if(index<0) index = slides.length-8; go(index);
    };
}

loadSlider();
</script>

</body>
</html>
