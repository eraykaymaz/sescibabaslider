<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Excel → Ürün Görüntüleme + SLIDER Üretici</title>

<style>
body{font-family:Arial;padding:15px;background:#f2f2f2;}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:15px;font-size:13px;}
th,td{border:1px solid #ccc;padding:4px 6px;}
.red-row{background:#ffe3e3!important;transition:background .6s;}
img{width:65px;height:65px;object-fit:contain;}
.flex-row{display:flex;gap:4px;align-items:center;}
.link-input{width:160px;padding:3px;font-size:12px;border:1px solid #aaa;border-radius:4px;}
.button-small{padding:4px 7px;font-size:12px;border:0;border-radius:4px;cursor:pointer;}
.btn-update{background:#1976d2;color:#fff;}
.btn-generate{margin-top:10px;background:#2e7d32;color:#fff;padding:8px 14px;font-size:14px;border:0;border-radius:6px;cursor:pointer;}
.git-link{color:#0d47a1;font-weight:bold;font-size:12px;}
.slider-btn{background:#d54c5a;color:#fff;border:0;padding:4px 7px;border-radius:4px;cursor:pointer;margin-top:4px;}
</style>

</head>
<body>

<h2>Excel → Ürün Görüntüleme + SLIDER Üretici</h2>

<input type="file" id="excelFile" accept=".xlsx">
<button class="btn-generate" onclick="generateProductsJS()">products.js ÜRET</button>

<table id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Ürün</th>
  <th>Fiyat</th>
  <th>Kategori</th>
  <th>(API) Kategori</th>
  <th>CAT</th>
  <th>İşlem</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

let PRODUCTS = {};
let CATEGORY_MAP = null;

/* -------------------------------------------------------
   EXCEL OKU
------------------------------------------------------- */
document.getElementById("excelFile").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    const data = await file.arrayBuffer();
    const excel = XLSX.read(data);
    const sheet = excel.Sheets[excel.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, {header:1});

    const tbody = document.querySelector("#productTable tbody");
    tbody.innerHTML = "";

    for(let i=1;i<rows.length;i++){
        const row = rows[i];
        const catName = row[0];
        const CAT = row[1];
        const link = row[2];

        if(!CAT) continue;

        PRODUCTS[CAT] = link || null;

        let api = link ? await fetchAPI(link) : blankAPI();

        renderRow(i, catName, CAT, link, api);
    }
});

/* -------------------------------------------------------
   TABLO SATIRI OLUŞTUR
------------------------------------------------------- */
function renderRow(i, catName, CAT, link, api){
    const tbody = document.querySelector("#productTable tbody");

    let tr = document.createElement("tr");
    if(api.stock === "YOK") tr.classList.add("red-row");

    let html = "";

    html += "<td><img src='"+api.image+"'></td>";
    html += "<td>"+api.title+"</td>";
    html += "<td>"+api.price+"</td>";
    html += "<td>"+catName+"</td>";
    html += "<td>"+api.category+"</td>";
    html += "<td>"+CAT+"</td>";

    html += "<td>";

    if(link && api.stock==="VAR"){
        html += "<a class='git-link' href='"+link+"' target='_blank'>Git</a>";
    } else {
        html += "<div class='flex-row'>";
        html += "<input class='link-input' id='inp_"+i+"' placeholder='Yeni link'>";
        html += "<button class='button-small btn-update' onclick=\"updateLink("+i+", '"+CAT+"')\">Güncelle</button>";
        html += "</div>";
    }

    html += "<button class='slider-btn' onclick=\"generateSlider('"+CAT+"')\">Slider Üret</button>";

    html += "</td>";

    tr.innerHTML = html;
    tbody.appendChild(tr);
}

/* -------------------------------------------------------
   LİNK GÜNCELLE
------------------------------------------------------- */
async function updateLink(i, CAT){
    const newLink = document.getElementById("inp_"+i).value.trim();
    if(!newLink) return;

    PRODUCTS[CAT] = newLink;

    const api = await fetchAPI(newLink);
    const row = document.getElementById("row_"+i);

    row.innerHTML = `
      <td><img src="${api.image}"></td>
      <td>${api.title}</td>
      <td>${api.price}</td>
      <td>-</td>
      <td>${api.category}</td>
      <td>${CAT}</td>
      <td>
        <a class="git-link" href="${newLink}" target="_blank">Git</a>
        <button class="slider-btn" onclick="generateSlider('${CAT}')">Slider Üret</button>
      </td>
    `;
}

/* -------------------------------------------------------
   API
------------------------------------------------------- */
async function fetchAPI(url){
    try{
        let r = await fetch("https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url="+encodeURIComponent(url));
        return await r.json();
    }catch(err){
        return blankAPI();
    }
}

function blankAPI(){
    return {title:"-", image:"", price:"-", category:"-", stock:"YOK"};
}

/* -------------------------------------------------------
   CATEGORY MAP LOAD
------------------------------------------------------- */
async function loadCategoryMap(){
    if(CATEGORY_MAP) return;

    await new Promise((resolve,reject)=>{
        let s = document.createElement("script");
        s.src = "./data/category-map.js?v="+Date.now();
        s.onload = ()=>{ CATEGORY_MAP = window.CATEGORY_MAP; resolve(); };
        s.onerror = reject;
        document.body.appendChild(s);
    });
}

/* -------------------------------------------------------
   SLIDER ÜRET
------------------------------------------------------- */
async function generateSlider(mainCAT){

    await loadCategoryMap();

    let related = CATEGORY_MAP[mainCAT]?.related || [];
    let items = "";

    for(let cat of related){
        const link = PRODUCTS[cat];
        if(!link) continue;

        const api = await fetchAPI(link);

        items += "<div class='slide-item'>";
        items += "<a href='"+link+"' target='_top'><img src='"+api.image+"'></a>";
        items += "<div class='product-title'>"+api.title+"</div>";

        if(api.stock === "YOK"){
            items += "<div class='out-stock'>Tükendi</div>";
        } else {
            items += "<div class='product-price'>"+api.price+"</div>";
        }

        items += "</div>";
    }

    const sliderHTML = buildSliderHTML(items);

    download(sliderHTML, mainCAT+"-slider.html", "text/html");
}

/* -------------------------------------------------------
   KIRILMAZ SLIDER HTML OLUŞTURUCU
------------------------------------------------------- */
function buildSliderHTML(items){

    let h = "";

    h += "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
    h += "<meta name='viewport' content='width=device-width'>";
    h += "<title>Slider</title>";

    h += "<style>";
    h += "body{margin:0;padding:0;font-family:Arial;}";
    h += ".slider-wrap{max-width:1850px;margin:auto;overflow:hidden;position:relative;}";
    h += ".slider-track{display:flex;gap:18px;transition:.5s;}";
    h += ".slide-item{width:150px;text-align:center;padding:20px 0;}";
    h += ".slide-item img{width:150px;height:150px;object-fit:contain;border-radius:12px;}";
    h += ".product-title{font-size:14px;font-weight:700;margin-top:10px;}";
    h += ".product-price{font-size:15px;font-weight:800;color:#d30000;margin-top:4px;}";
    h += ".out-stock{font-size:14px;font-weight:700;color:#999;margin-top:6px;}";
    h += ".slider-arrow{position:absolute;top:45%;width:40px;height:40px;background:#fff;border:0;border-radius:50%;font-size:22px;cursor:pointer;}";
    h += ".slider-prev{left:5px;} .slider-next{right:5px;}";
    h += "</style>";

    h += "<script>";
    h += "let index=0;";
    h += "window.onload=function(){";
    h += "const t=document.getElementById('sliderTrack');";
    h += "const s=[...t.children]; const w=168;";
    h += "document.querySelector('.slider-next').onclick=function(){index++; if(index>=s.length-8) index=0; t.style.transform='translateX('+(-index*w)+'px)';};";
    h += "document.querySelector('.slider-prev').onclick=function(){index--; if(index<0) index=s.length-8; t.style.transform='translateX('+(-index*w)+'px)';};";
    h += "}";
    h += "</script>";

    h += "</head><body>";

    h += "<div class='slider-wrap'>";
    h += "<button class='slider-arrow slider-prev'>❮</button>";
    h += "<div class='slider-track' id='sliderTrack'>";
    h += items;
    h += "</div>";
    h += "<button class='slider-arrow slider-next'>❯</button>";
    h += "</div>";

    h += "</body></html>";

    return h;
}

/* -------------------------------------------------------
   DOSYA İNDİR
------------------------------------------------------- */
function download(content, filename, type){
    const blob = new Blob([content], {type});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

</script>

</body>
</html>
