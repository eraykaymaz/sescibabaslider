<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Excel → Slider Üretici</title>

<style>
body{font-family:Arial;padding:15px;background:#f2f2f2;}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:15px;font-size:13px;}
th,td{border:1px solid #ccc;padding:4px;}
img{width:60px;height:60px;object-fit:contain;}
.red-row{background:#ffe3e3;}
.slider-btn{background:#ff8c00;color:#fff;border:0;padding:4px 6px;font-size:12px;border-radius:4px;cursor:pointer;}
.git-link{color:#0d47a1;font-weight:bold;font-size:12px;}
</style>

</head>
<body>

<h2>Excel → Ürün Görüntüleme & Slider Üretici</h2>

<input type="file" id="excelFile" accept=".xlsx">

<table id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Ürün</th>
  <th>Fiyat</th>
  <th>CAT</th>
  <th>Link</th>
  <th>Slider</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

/* -------------------------------- */
/* VERİ DOSYALARINI YÜKLE          */
/* -------------------------------- */

let CATEGORY_MAP = {};
let PRODUCTS = {};

function loadScript(src){
    return new Promise(res=>{
        const s=document.createElement("script");
        s.src = src+"?v="+Date.now();
        s.onload = res;
        document.body.appendChild(s);
    });
}

async function loadAllData(){
    await loadScript("./data/category-map.js");
    CATEGORY_MAP = window.CATEGORY_MAP;

    await loadScript("./data/products.js");
    PRODUCTS = window.PRODUCTS;
}

loadAllData().then(()=>console.log("Veriler yüklendi"));

/* -------------------------------- */
/* EXCEL YÜKLEME                    */
/* -------------------------------- */

document.getElementById("excelFile").addEventListener("change", handleExcel);

async function handleExcel(e){
    const file = e.target.files[0];
    const data = await file.arrayBuffer();
    const excel = XLSX.read(data);
    const sheet = excel.Sheets[excel.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const tbody = document.querySelector("#productTable tbody");
    tbody.innerHTML = "";

    for(let i=1;i<rows.length;i++){
        const row = rows[i];
        const CAT = row[1];
        const link = row[2];

        if(!CAT) continue;

        if(!PRODUCTS[CAT]) PRODUCTS[CAT] = [];
        if(link) PRODUCTS[CAT][0] = link;

        let api = link ? await fetchAPI(link) : {title:"-",price:"-",image:"",stock:"YOK"};

        const tr=document.createElement("tr");
        if(api.stock==="YOK") tr.classList.add("red-row");

        tr.innerHTML = `
            <td><img src="${api.image}"></td>
            <td>${api.title}</td>
            <td>${api.price}</td>
            <td>${CAT}</td>
            <td>${link ? `<a class="git-link" href="${link}" target="_blank">Git</a>` : "-"}</td>
            <td><button class="slider-btn" onclick="createSlider('${CAT}')">Slider Üret</button></td>
        `;

        tbody.appendChild(tr);
    }
}

/* -------------------------------- */
/* API ÇEK                          */
/* -------------------------------- */

async function fetchAPI(url){
    try{
        const r = await fetch("https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url="+encodeURIComponent(url));
        return await r.json();
    }catch(e){
        return {title:"-",price:"-",image:"",stock:"YOK"};
    }
}

/* -------------------------------- */
/* SLIDER ÜRET                      */
/* -------------------------------- */

window.createSlider = async function(CAT){
    const related = CATEGORY_MAP[CAT]?.related || [];
    let items=[];

    for(const rc of related){
        const link = PRODUCTS[rc]?.[0];
        if(!link) continue;

        const api = await fetchAPI(link);
        items.push({link, ...api});
    }

    const html = sliderHTML(CAT, items);
    const blob = new Blob([html], {type:"text/html"});
    const a=document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = CAT+".html";
    a.click();
}

/* -------------------------------- */
/* HTML + CSS SLIDER TEMPLATE       */
/* -------------------------------- */

function sliderHTML(CAT, items){
return `
<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${CAT}</title>
<style>
body{margin:0;padding:0;font-family:Arial;}
.slider{display:flex;overflow-x:auto;gap:18px;padding:20px;}
.item{min-width:150px;text-align:center;}
.item img{width:150px;height:150px;object-fit:contain;border-radius:12px;}
.title{margin-top:8px;font-size:14px;font-weight:700;}
.price{color:#d00;font-weight:700;margin-top:4px;}
.stock{color:#aaa;margin-top:4px;font-weight:700;}
</style>
</head>
<body>

<div class="slider">
${items.map(p=>`
<div class="item">
<a href="${p.link}" target="_top"><img src="${p.image}"></a>
<div class="title">${p.title}</div>
${p.stock==="VAR" ? `<div class="price">${p.price}</div>` : `<div class="stock">Tükendi</div>`}
</div>
`).join("")}
</div>

</body></html>`;
}

</script>

</body>
</html>
