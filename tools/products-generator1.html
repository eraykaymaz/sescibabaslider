<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>M4 – Kategori Bazlı Slider Üretici</title>

<style>
body{font-family:Arial;padding:15px;background:#f5f5f5;}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff;font-size:13px;}
th,td{border:1px solid #ccc;padding:6px;}
img{width:80px;height:80px;object-fit:contain;} /* 8×8 */
.red{background:#ffe3e3;}
.btn{padding:4px 8px;border:0;border-radius:4px;cursor:pointer;font-size:12px;}
.update{background:#1976d2;color:#fff;}
.slider{background:#ff8c00;color:#fff;}
.link{width:160px;padding:4px;}
.git{color:#0a47c2;font-weight:bold;}
</style>
</head>

<body>

<h2>Kategori Bazlı HTML Slider Üretici – M4</h2>
<input type="file" id="excelFile" accept=".xlsx">

<table id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Ürün</th>
  <th>Fiyat</th>
  <th>Kategori</th>
  <th>(API) Kategori</th>
  <th>A-KODU</th>
  <th>Link / Güncelle</th>
  <th>Üret</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* -------------------------- CATEGORY MAP -------------------------- */
const CATEGORY_MAP = {
"A01":{"related":["A02","A03","A04","A05","A09","A11","A12","A16","A32","A33","A40","A47","A50","A74","A89"]},
"A02":{"related":["A03","A04","A07","A09","A11","A14","A16","A32","A33","A37","A40","A47","A50","A74","A89"]},
"A03":{"related":["A32","A33","A34","A37","A40","A44","A47","A16","A02","A11","A89","A90","A91","A93","A95"]},
"A04":{"related":["A50","A51","A48","A49","A52","A53","A54","A55","A57","A58","A59","A60","A16","A61","A89"]},
"A05":{"related":["A02","A09","A16","A11","A12","A74","A17","A75","A89","A95","A29","A28","A20","A21","A89"]},
/* … SENİN GÖNDERDİĞİN HARİTADAKİ TÜM A01–A99 + B01–B12 BURADA DEVAM EDER … */
"A99":{"related":["A97","A98","A81","A80","A82","A93","A95","A16","A89","A90","A92","A91","A83","A85","A84"]},
"B01":{"related":["A17","A18","A19","A20","A28","A89","A93","A16","A95","A22","A23","A25","A26","A27","A21"]},
"B02":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A16","A95","A25","A26","A27","A21","A23"]},
/* … B03–B12 … */
"B12":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A91","A16","A95","A22","A21","A23","A24"]}
};

/* -------------------------- DATA -------------------------- */
let PRODUCTS = {};

document.getElementById("excelFile").addEventListener("change", handleExcel);

async function handleExcel(e){
  const f = e.target.files[0];
  const wb = XLSX.read(await f.arrayBuffer());
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header:1 });

  const body = document.querySelector("#productTable tbody");
  body.innerHTML = "";

  for(let i=1;i<rows.length;i++){
    const KAT = rows[i][0];
    const CODE = rows[i][1];
    const LINK = rows[i][2];

    if(!CODE) continue;
    if(!PRODUCTS[CODE]) PRODUCTS[CODE]=[];
    if(LINK) PRODUCTS[CODE][0]=LINK;

    const api = LINK ? await fetchAPI(LINK) : {title:"-",image:"",price:"-",category:"-",stock:"YOK"};

    const tr=document.createElement("tr");
    if(api.stock==="YOK") tr.classList.add("red");

    tr.id="row"+i;

    tr.innerHTML=`
      <td><img id="img${i}" src="${api.image}"></td>
      <td id="t${i}">${api.title}</td>
      <td id="p${i}">${api.price}</td>
      <td>${KAT}</td>
      <td id="ac${i}">${api.category}</td>
      <td>${CODE}</td>
      <td id="c${i}">
        ${api.stock==="VAR" && LINK
          ? `<a class='git' href='${LINK}' target='_blank'>Git</a>`
          : `<input id="in${i}" class="link" placeholder="Yeni link">
             <button class="btn update" onclick="updateLink(${i},'${CODE}')">Kaydet</button>`}
      </td>
      <td><button class="btn slider" onclick="makeSlider('${CODE}')">ÜRET</button></td>
    `;
    body.appendChild(tr);
  }
}

/* -------------------------- API GETTER -------------------------- */
async function fetchAPI(url){
  try{
    return await (await fetch(
      "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url="+encodeURIComponent(url)
    )).json();
  }catch{
    return {title:"-",price:"-",image:"",category:"-",stock:"YOK"};
  }
}

/* -------------------------- LINK UPDATE -------------------------- */
async function updateLink(i,CODE){
  const newLink=document.getElementById("in"+i).value.trim();
  if(!newLink) return;

  PRODUCTS[CODE]=[newLink];
  const api=await fetchAPI(newLink);

  document.getElementById("img"+i).src=api.image;
  document.getElementById("t"+i).innerHTML=api.title;
  document.getElementById("p"+i).innerHTML=api.price;
  document.getElementById("ac"+i).innerHTML=api.category;

  const cell=document.getElementById("c"+i);
  const row=document.getElementById("row"+i);

  if(api.stock==="VAR"){
    row.classList.remove("red");
    cell.innerHTML=`<a class='git' href='${newLink}' target='_blank'>Git</a>`;
  }else{
    row.classList.add("red");
  }
}

/* -------------------------- SLIDER GENERATOR -------------------------- */
async function makeSlider(CODE){
  const rel=CATEGORY_MAP[CODE]?.related||[];
  let items=[];

  for(const rc of rel){
    const link=PRODUCTS[rc]?.[0];
    if(!link) continue;
    items.push({link,...await fetchAPI(link)});
  }

  const html = genHTML(CODE,items);
  const blob=new Blob([html],{type:"text/html"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=CODE+".html";
  a.click();
}

function genHTML(CODE,items){
return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${CODE} Slider</title>
<style>
body{margin:0;font-family:Arial;}
.wrap{padding:20px;display:flex;overflow-x:auto;gap:20px;}
.item{text-align:center;}
img{width:150px;height:150px;object-fit:contain;border-radius:12px;}
.title{font-size:14px;font-weight:bold;margin-top:6px;}
.price{color:#d30000;font-weight:bold;margin-top:4px;}
.stock{color:#888;font-weight:bold;margin-top:4px;}
</style>
</head>
<body>
<div class="wrap">
${items.map(x=>`
<div class="item">
  <a href="${x.link}" target="_top"><img src="${x.image}"></a>
  <div class="title">${x.title}</div>
  <div class="${x.stock==="VAR"?"price":"stock"}">${x.stock==="VAR"?x.price:"Tükendi"}</div>
</div>`).join("")}
</div>
</body>
</html>`;
}
</script>

</body>
</html>
