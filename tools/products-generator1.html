<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Excel → Ürün Görüntüleme & HIT Üretici</title>

<style>
body{font-family:Arial;padding:15px;background:#f2f2f2;}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:15px;font-size:13px;}
th,td{border:1px solid #ccc;padding:4px 6px;}
.red-row{background:#ffe3e3!important;transition:background .6s ease;}
img{width:65px;height:65px;object-fit:contain;}
.flex-row{display:flex;gap:4px;align-items:center;}
.link-input{width:160px;padding:3px;font-size:12px;border:1px solid #aaa;border-radius:4px;}
.button-small{padding:4px 7px;font-size:12px;border:0;border-radius:4px;cursor:pointer;}
.btn-update{background:#1976d2;color:#fff;}
.btn-generate{margin-top:10px;background:#2e7d32;color:#fff;padding:8px 14px;font-size:14px;border:0;border-radius:6px;cursor:pointer;}
.git-link{color:#0d47a1;font-weight:bold;font-size:12px;}
.slider-btn{background:#ff8c00;color:#fff;border:0;padding:4px 6px;font-size:12px;border-radius:4px;cursor:pointer;margin-left:4px;}
</style>

</head>
<body>

<h2>Excel → Ürün Görüntüleme & HIT Üretici</h2>

<input type="file" id="excelFile" accept=".xlsx">
<button class="btn-generate" onclick="generateProductsJS()">products.js ÜRET</button>

<table id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Ürün</th>
  <th>Fiyat</th>
  <th>Kategori</th>
  <th>(API) Kategori</th>
  <th>CAT</th>
  <th>Link / Güncelle</th>
  <th>Slider</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

let PRODUCTS = {};
let CATEGORY_MAP = {};
let dataReady = { products:false, map:false };

/* ------------------------------------ */
/* DOSYALARI YÜKLE                       */
/* ------------------------------------ */
function loadDataFiles(){
    return new Promise(resolve=>{
        const s1 = document.createElement("script");
        s1.src = "./data/category-map.js?v="+Date.now();
        s1.onload = ()=>{ CATEGORY_MAP = window.CATEGORY_MAP; dataReady.map = true; check(); };
        document.body.appendChild(s1);

        const s2 = document.createElement("script");
        s2.src = "./data/products.js?v="+Date.now();
        s2.onload = ()=>{ PRODUCTS = window.PRODUCTS; dataReady.products = true; check(); };
        document.body.appendChild(s2);

        function check(){
            if(dataReady.map && dataReady.products){
                resolve();
            }
        }
    });
}

await loadDataFiles();

/* ------------------------------------ */
/* EXCEL YÜKLEME                        */
/* ------------------------------------ */
document.getElementById("excelFile").addEventListener("change", handleExcel);

async function handleExcel(e){
    const file = e.target.files[0];
    const data = await file.arrayBuffer();
    const excel = XLSX.read(data);
    const sheet = excel.Sheets[excel.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const tbody = document.querySelector("#productTable tbody");
    tbody.innerHTML = "";

    for(let i=1;i<json.length;i++){
        const row = json[i];
        const categoryName = row[0];
        const CAT = row[1];
        let link = row[2];

        if(!CAT) continue;

        if(!PRODUCTS[CAT]) PRODUCTS[CAT] = [];
        if(link) PRODUCTS[CAT].push(link);

        let api = link ? await fetchAPI(link) : {
          title:"-", image:"", price:"-", category:"-", stock:"YOK"
        };

        renderRow(i, row, api, CAT);
    }
}

/* ------------------------------------ */
/* SATIR OLUŞTUR                         */
/* ------------------------------------ */
function renderRow(i, row, api, CAT){
    const tbody = document.querySelector("#productTable tbody");
    const tr = document.createElement("tr");
    tr.id = "row_"+i;

    const categoryName = row[0];
    const link = row[2];

    if(api.stock === "YOK") tr.classList.add("red-row");

    tr.innerHTML = `
      <td id="img_${i}"><img src="${api.image||""}"></td>
      <td id="title_${i}">${api.title}</td>
      <td id="price_${i}">${api.price}</td>
      <td>${categoryName}</td>
      <td id="catapi_${i}">${api.category||"-"}</td>
      <td>${CAT}</td>
      <td id="cell_${i}">
        ${getLinkHTML(i, CAT, link, api.stock)}
      </td>
      <td>
        <button class="slider-btn" onclick="createSlider('${CAT}')">Slider Üret</button>
      </td>
    `;

    tbody.appendChild(tr);
}

function getLinkHTML(i, CAT, link, stock){
    if(stock === "VAR" && link){
        return `<a class="git-link" href="${link}" target="_blank">Git</a>`;
    }

    return `
      <div class="flex-row">
        <input class="link-input" id="inp_${i}" placeholder="Yeni link">
        <button class="button-small btn-update" onclick="updateLink(${i}, '${CAT}')">Güncelle</button>
      </div>
    `;
}

/* ------------------------------------ */
/* API                                   */
/* ------------------------------------ */
async function fetchAPI(url){
    try{
        const r = await fetch("https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url="+encodeURIComponent(url));
        return await r.json();
    }catch(e){
        return {title:"-",price:"-",image:"",category:"-",stock:"YOK"};
    }
}

/* ------------------------------------ */
/* PRODUCTS.JS ÜRET                       */
/* ------------------------------------ */
function generateProductsJS(){
    const text = "window.PRODUCTS = " + JSON.stringify(PRODUCTS, null, 2) + ";";
    const blob = new Blob([text], {type:"application/javascript"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "products.js";
    a.click();
}

/* ------------------------------------ */
/* SLIDER ÜRET (HTML + CSS)              */
/* ------------------------------------ */
async function createSlider(CAT){
    const related = CATEGORY_MAP[CAT]?.related || [];

    let items = [];

    for(const rc of related){
        const link = PRODUCTS[rc]?.[0];
        if(!link) continue;

        const api = await fetchAPI(link);
        items.push({ link, ...api });
    }

    const html = buildCSSHTMLSlider(CAT, items);

    const blob = new Blob([html], {type:"text/html"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = CAT + ".html";
    a.click();
}

/* ------------------------------------ */
/* PURE HTML CSS SLIDER GENERATOR       */
/* ------------------------------------ */
function buildCSSHTMLSlider(CAT, items){
return `
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>${CAT}</title>

<style>
body{margin:0;padding:0;font-family:Arial;}
.slider-container{
  display:flex;overflow-x:auto;gap:18px;padding:20px;
  scroll-behavior:smooth;
}
.item{min-width:150px;text-align:center;}
.item img{
  width:150px;height:150px;object-fit:contain;
  border-radius:12px;background:#fff;
}
.title{margin-top:8px;font-size:14px;font-weight:700;}
.price{margin-top:4px;font-size:15px;font-weight:800;color:#d30000;}
.stock{margin-top:4px;font-size:14px;font-weight:700;color:#777;}
</style>

</head>
<body>

<div class="slider-container">
${items.map(p=>`
  <div class="item">
    <a href="${p.link}" target="_top">
      <img src="${p.image}">
    </a>
    <div class="title">${p.title}</div>
    ${p.stock==="VAR" ? `<div class="price">${p.price}</div>` : `<div class="stock">Tükendi</div>`}
  </div>
`).join("")}
</div>

</body>
</html>`;
}

</script>

</body>
</html>
