<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Slider Üretici – A01 MAP</title>

<style>
body{font-family:Arial;padding:10px;background:#f5f5f5;}
table{width:100%;border-collapse:collapse;background:#fff;font-size:13px;margin-top:10px;}
th,td{border:1px solid #ccc;padding:3px;}
img{width:80px;height:80px;object-fit:contain;}
.red{background:#ffe3e3;}
.link-input{width:150px;font-size:12px;padding:3px;}
.update-btn{padding:3px 6px;background:#1976d2;color:#fff;border:0;border-radius:4px;font-size:12px;cursor:pointer;}
.btn-slider{padding:3px 6px;background:#ff8c00;color:#fff;border:0;border-radius:4px;font-size:12px;cursor:pointer;}
</style>
</head>

<body>

<h3>Kategori Bazlı Slider Üretici</h3>

<input type="file" id="excelFile" accept=".xlsx">

<table id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Ürün</th>
  <th>Fiyat</th>
  <th>Kategori<br>(API)</th>
  <th>A-KODU</th>
  <th>Link / Güncelle</th>
  <th>Slider Üret</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>

/* ============================================================
      A01 MAP — SADECE TEK KATEGORİ (Sen genişleteceksin)
============================================================ */
const CATEGORY_MAP = {
  "A01": {"related": ["A02","A03","A04","A05","A09","A11","A12","A16","A32","A33","A40","A47","A50","A74","A89"]
  "A02": {"related":["A03","A04","A07","A09","A11","A14","A16","A32","A33","A37","A40","A47","A50","A74","A89"]
  
};

/* ============================================================
      GLOBAL
============================================================ */
let PRODUCTS = {};

/* ============================================================
      EXCEL OKUMA
============================================================ */
document.getElementById("excelFile").addEventListener("change", async (e)=>{
  const file = e.target.files[0];
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf);
  const sh = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sh,{header:1});

  const tbody = document.querySelector("#productTable tbody");
  tbody.innerHTML = "";

  for(let i=1;i<rows.length;i++){
    const KAT = rows[i][0];
    const CODE = rows[i][1];
    let LINK  = rows[i][2];

    if(!CODE) continue;

    if(!PRODUCTS[CODE]) PRODUCTS[CODE] = [];
    if(LINK) PRODUCTS[CODE][0] = LINK;

    const api = LINK ? await fetchAPI(LINK) : {title:"-",image:"",price:"-",category:"-",stock:"YOK"};

    const tr = document.createElement("tr");
    if(api.stock==="YOK") tr.classList.add("red");

    tr.innerHTML = `
      <td><img src="${api.image}"></td>
      <td>${api.title}</td>
      <td>${api.price}</td>
      <td>${KAT}<br><b>${api.category}</b></td>
      <td>${CODE}</td>
      <td id="cell_${i}">
        ${api.stock==="VAR" && LINK ? `
          <a href="${LINK}" target="_blank">Git</a>
        `:`
          <input id="inp_${i}" class="link-input" value="${LINK||""}">
          <button class="update-btn" onclick="updateLink(${i},'${CODE}')">Güncelle</button>
        `}
      </td>
      <td><button class="btn-slider" onclick="makeSlider('${CODE}')">Slider Üret</button></td>
    `;
    tbody.appendChild(tr);
  }
});

/* ============================================================
      API
============================================================ */
async function fetchAPI(url){
  try{
    const r = await fetch("https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url="+encodeURIComponent(url));
    return await r.json();
  }catch(e){
    return {title:"-",image:"",price:"-",category:"-",stock:"YOK"};
  }
}

/* ============================================================
      GÜNCELLEME
============================================================ */
window.updateLink = async function(i,CODE){
  const newLink = document.getElementById("inp_"+i).value.trim();
  if(!newLink) return;

  PRODUCTS[CODE] = [newLink];
  const api = await fetchAPI(newLink);

  const row = document.querySelectorAll("#productTable tbody tr")[i-1];
  const cell = document.getElementById("cell_"+i);

  row.children[0].innerHTML = `<img src="${api.image}">`;
  row.children[1].innerHTML = api.title;
  row.children[2].innerHTML = api.price;
  row.children[3].children[1].innerHTML = api.category;

  if(api.stock==="VAR"){
    row.classList.remove("red");
    cell.innerHTML = `<a href="${newLink}" target="_blank">Git</a>`;
  }else{
    row.classList.add("red");
    cell.innerHTML = `
      <input id="inp_${i}" class="link-input" value="${newLink}">
      <button class="update-btn" onclick="updateLink(${i},'${CODE}')">Güncelle</button>
    `;
  }
};

/* ============================================================
      SLIDER ÜRETME
============================================================ */
window.makeSlider = async function(CODE){
  const rel = CATEGORY_MAP[CODE]?.related || [];
  let items = [];

  for(const r of rel){
    const link = PRODUCTS[r]?.[0];
    if(!link) continue;
    const api = await fetchAPI(link);
    items.push({link,...api});
  }

  const html = sliderHTML(CODE, items);

  const blob = new Blob([html],{type:"text/html"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = CODE+".html";
  a.click();
};

/* ============================================================
      SLIDER HTML — BUTTER-SMOOTH, OK TUŞLU
============================================================ */
function sliderHTML(CODE, items){
return `
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>${CODE} Slider</title>
<style>
body{margin:0;font-family:Arial;}
.wrap{position:relative;padding:20px;}
.slider{
  display:flex;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  gap:20px;
  padding-bottom:10px;
}
.item{
  flex:0 0 auto;
  scroll-snap-align:start;
  text-align:center;
}
.item img{
  width:150px;
  height:150px;
  object-fit:contain;
}
.arrow{
  position:absolute;
  top:45%;
  background:#fff;
  padding:10px 14px;
  border-radius:50%;
  font-size:20px;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
}
.left{left:10px;}
.right{right:10px;}
</style>
</head>

<body>
<div class="wrap">
  <div class="arrow left" onclick="document.querySelector('.slider').scrollBy({left:-250,behavior:'smooth'})">❮</div>
  <div class="arrow right" onclick="document.querySelector('.slider').scrollBy({left:250,behavior:'smooth'})">❯</div>

  <div class="slider">
    ${items.map(x=>`
      <div class="item">
        <a href="${x.link}" target="_top">
          <img src="${x.image}">
        </a>
        <div>${x.title}</div>
        <div>${x.stock==="VAR"?x.price:"Tükendi"}</div>
      </div>
    `).join("")}
  </div>
</div>
</body>
</html>
`;
}

</script>

</body>
</html>
