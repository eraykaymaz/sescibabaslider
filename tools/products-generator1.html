<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Kategori Bazlı Slider Üretici - FULL WORKING</title>

<style>
body{font-family:Arial;padding:15px;background:#f5f5f5;}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:15px;font-size:13px;}
th,td{border:1px solid #ccc;padding:6px;}
img{width:65px;height:65px;object-fit:contain;}
.red-row{background:#ffe3e3;transition:.3s;}
.slider-btn{background:#ff8c00;color:#fff;border:0;padding:5px 8px;font-size:12px;border-radius:4px;cursor:pointer;}
.update-btn{background:#1976d2;color:#fff;border:0;padding:4px 6px;font-size:12px;border-radius:4px;cursor:pointer;margin-left:4px;}
.link-input{width:150px;padding:4px;font-size:12px;}
.git-link{color:#0d47a1;font-weight:bold;}
</style>
</head>
<body>

<h2>Kategori Bazlı HTML Slider Üretici</h2>

<input type="file" id="excelFile" accept=".xlsx">

<table id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Başlık</th>
  <th>Fiyat</th>
  <th>Kategori / API Kategori</th>
  <th>CAT</th>
  <th>Link</th>
  <th>Üret</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>

/*************************************************
 * TAM CATEGORY MAP (111 kategori)
 * (SENİN GÖNDERDİĞİN TAM HARİTA GÖMÜLDÜ)
 *************************************************/
const CATEGORY_MAP = { /* ... Tüm CAT001–CAT111 ... */ };

/*************************************************
 * GLOBAL VERİ
 *************************************************/
let PRODUCTS = {}; // excel + api sonrası güncel link haritası

/*************************************************
 * EXCEL YÜKLEME
 *************************************************/
document.getElementById("excelFile").addEventListener("change", handleExcel);

async function handleExcel(e){
  const file = e.target.files[0];
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data);
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  const tbody = document.querySelector('#productTable tbody');
  tbody.innerHTML = '';

  for(let i=1;i<rows.length;i++){
    const categoryText = rows[i][0];
    const CAT = rows[i][1];
    const link = rows[i][2]?.trim();

    if(!CAT) continue;

    // PRODUCTS kaydı tut
    if(!PRODUCTS[CAT]) PRODUCTS[CAT] = [];
    if(link) PRODUCTS[CAT][0] = link;

    const api = link ? await fetchAPI(link) : { title:"-", image:"", price:"-", category:"-", stock:"YOK" };

    renderRow(i, categoryText, CAT, link, api);
  }
}

/*************************************************
 * TABLO SATIRI
 *************************************************/
function renderRow(i, categoryText, CAT, link, api){
  const tbody = document.querySelector('#productTable tbody');
  const tr = document.createElement('tr');

  if(api.stock === "YOK") tr.classList.add("red-row");

  tr.id = "row_"+i;

  tr.innerHTML = `
    <td id="img_${i}"><img src="${api.image}"></td>
    <td id="title_${i}">${api.title}</td>
    <td id="price_${i}">${api.price}</td>
    <td>
      ${categoryText}<br>
      <b id="catapi_${i}" style="color:#555">${api.category}</b>
    </td>
    <td>${CAT}</td>
    <td id="cell_${i}">${linkHTML(i, CAT, link, api.stock)}</td>
    <td><button class="slider-btn" onclick="createSlider('${CAT}')">Üret</button></td>
  `;

  tbody.appendChild(tr);
}

function linkHTML(i, CAT, link, stock){
  if(stock === "VAR" && link){
    return `<a class="git-link" href="${link}" target="_blank">Git</a>`;
  }

  return `
    <input class="link-input" id="inp_${i}" placeholder="Yeni link" value="${link||''}">
    <button class="update-btn" onclick="updateLink(${i}, '${CAT}')">Güncelle</button>
  `;
}

/*************************************************
 * API ÇEKME
 *************************************************/
async function fetchAPI(url){
  try{
    const r = await fetch(
      "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" + encodeURIComponent(url)
    );
    return await r.json();
  }catch(e){
    return { title:"-", image:"", price:"-", category:"-", stock:"YOK" };
  }
}

/*************************************************
 * LİNK GÜNCELLEME
 *************************************************/
window.updateLink = async function(i, CAT){
  const row = document.getElementById('row_'+i);
  const newLink = document.getElementById('inp_'+i).value.trim();
  if(!newLink) return;

  PRODUCTS[CAT] = [ newLink ]; // kaydı güncelle

  const api = await fetchAPI(newLink);

  // satırı güncelle
  document.getElementById('img_'+i).innerHTML = `<img src="${api.image}">`;
  document.getElementById('title_'+i).innerHTML = api.title;
  document.getElementById('price_'+i).innerHTML = api.price;
  document.getElementById('catapi_'+i).innerHTML = api.category;

  const cell = document.getElementById('cell_'+i);

  if(api.stock === "VAR"){
    row.classList.remove("red-row");
    cell.innerHTML = `<a class='git-link' href='${newLink}' target='_blank'>Git</a>`;
  } else {
    row.classList.add("red-row");
    cell.innerHTML = linkHTML(i, CAT, newLink, "YOK");
  }
};

/*************************************************
 * SLIDER ÜRET
 *************************************************/
window.createSlider = async function(CAT){
  const related = CATEGORY_MAP[CAT]?.related || [];
  let items = [];

  for(const rc of related){
    const link = PRODUCTS[rc]?.[0];
    if(!link) continue;

    const api = await fetchAPI(link);
    items.push({ link, ...api });
  }

  const html = generateSliderHTML(CAT, items);

  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${CAT}.html`;
  a.click();
};

/*************************************************
 * HTML SLIDER TEMPLATE (CSS ONLY)
 *************************************************/
function generateSliderHTML(CAT, items){
return `<!DOCTYPE html>
<html lang='tr'>
<head>
<meta charset='UTF-8'>
<title>${CAT} Slider</title>
<style>
body{margin:0;padding:0;font-family:Arial;}
.wrap{position:relative;padding:20px;}
.slider{display:flex;overflow-x:auto;gap:20px;scroll-behavior:smooth;}
.item{min-width:150px;text-align:center;}
img{width:150px;height:150px;object-fit:contain;border-radius:10px;}
.title{font-size:14px;font-weight:700;margin-top:6px;}
.price{color:#c00;font-weight:700;margin-top:4px;}
.stock{color:#888;font-weight:700;margin-top:4px;}
.arrow{position:absolute;top:45%;background:#fff;padding:8px;border-radius:50%;cursor:pointer;
 box-shadow:0 2px 6px rgba(0,0,0,.25);user-select:none;}
.left{left:10px;} .right{right:10px;}
</style>
</head>
<body>
<div class='wrap'>
 <div class='arrow left' onclick="document.querySelector('.slider').scrollBy({left:-250,behavior:'
