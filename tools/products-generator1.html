<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Minimal Slider √úretici ‚Äì FINAL FIX</title>

<style>
body{font-family:Arial;padding:10px;background:#f5f5f5;margin:0;}
table{width:100%;border-collapse:collapse;background:#fff;font-size:13px;margin-top:10px;}
th,td{border:1px solid #ccc;padding:3px;}
img{width:80px;height:80px;object-fit:contain;}
.red{background:#ffe3e3;}
.link-input{width:150px;font-size:12px;padding:3px;}
.update-btn{padding:3px 6px;background:#1976d2;color:#fff;border:0;border-radius:4px;font-size:12px;cursor:pointer;}
.btn-slider{padding:3px 6px;background:#ff8c00;color:#fff;border:0;border-radius:4px;font-size:12px;cursor:pointer;}
</style>
</head>

<body>

<h3>Minimal Kategori Bazlƒ± Slider √úretici</h3>

<input type="file" id="excelFile" accept=".xlsx">

<table id="productTable">
<thead>
<tr>
  <th>G√∂rsel</th>
  <th>√úr√ºn</th>
  <th>Fiyat</th>
  <th>Kategori<br>(API)</th>
  <th>A-KODU</th>
  <th>Link / G√ºncelle</th>
  <th>Slider √úret</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>

/* ----------------- A01‚ÄìA03 MAP (D√úZELTƒ∞LMƒ∞≈û) ----------------- */
const CATEGORY_MAP = {
  "A01": { "related": ["A02","A03","A04","A05","A09","A11","A12","A16","A32","A33","A40","A47","A50","A74","A89"] },
  "A02": { "related": ["A03","A04","A07","A09","A11","A14","A16","A32","A33","A37","A40","A47","A50","A74","A89"] },
  "A03": { "related": ["A32","A33","A34","A37","A40","A44","A47","A16","A02","A11","A89","A90","A91","A93","A95"] }
};

/* ----------------- GLOBAL ----------------- */
let PRODUCTS = {};

/* ----------------- EXCEL Y√úKLE ----------------- */
document.getElementById("excelFile").addEventListener("change", async (e)=>{
  const buf = await e.target.files[0].arrayBuffer();
  const wb = XLSX.read(buf);

  // ƒ∞lk sayfayƒ± otomatik se√ß
  const sheetName = wb.SheetNames[0];
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { header:1 });

  const tbody = document.querySelector("#productTable tbody");
  tbody.innerHTML = "";

  for(let i=1;i<rows.length;i++){
    const KAT = rows[i][0];
    const CODE = rows[i][1];
    const LINK = rows[i][2];

    if(!CODE) continue;

    if(!PRODUCTS[CODE]) PRODUCTS[CODE] = [];
    if(LINK) PRODUCTS[CODE][0] = LINK;

    const api = LINK ? await fetchAPI(LINK) : {title:"-",image:"",price:"-",category:"-",stock:"YOK"};

    const tr = document.createElement("tr");
    if(api.stock==="YOK") tr.classList.add("red");

    tr.innerHTML = `
      <td><img src="${api.image}"></td>
      <td>${api.title}</td>
      <td>${api.price} ‚Ç∫</td>
      <td>${KAT}<br><b>${api.category}</b></td>
      <td>${CODE}</td>
      <td id="cell_${i}">
        ${api.stock==="VAR" && LINK ? 
          `<a href="${LINK}" target="_blank">Git</a>` :
          `<input id="inp_${i}" class="link-input" value="${LINK||""}">
           <button class="update-btn" onclick="updateLink(${i},'${CODE}')">G√ºncelle</button>`
        }
      </td>
      <td><button class="btn-slider" onclick="makeSlider('${CODE}')">Slider √úret</button></td>
    `;
    tbody.appendChild(tr);
  }
});

/* ----------------- API ----------------- */
async function fetchAPI(url){
  try{
    return await (await fetch("https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url="+encodeURIComponent(url))).json();
  }catch(e){
    return {title:"-",image:"",price:"-",category:"-",stock:"YOK"};
  }
}

/* ----------------- G√úNCELLE ----------------- */
window.updateLink = async (i,CODE)=>{
  const newLink = document.getElementById("inp_"+i).value.trim();
  if(!newLink) return;

  PRODUCTS[CODE] = [newLink];
  const api = await fetchAPI(newLink);

  const row = document.querySelectorAll("#productTable tbody tr")[i-1];
  const cell = document.getElementById("cell_"+i);

  row.children[0].innerHTML = `<img src="${api.image}">`;
  row.children[1].innerHTML = api.title;
  row.children[2].innerHTML = api.price + " ‚Ç∫";
  row.children[3].children[1].innerHTML = api.category;

  if(api.stock==="VAR"){
    row.classList.remove("red");
    cell.innerHTML = `<a href="${newLink}" target="_blank">Git</a>`;
  } else {
    row.classList.add("red");
    cell.innerHTML = `
      <input id="inp_${i}" class="link-input" value="${newLink}">
      <button class="update-btn" onclick="updateLink(${i},'${CODE}')">G√ºncelle</button>`;
  }
};

/* ----------------- SLIDER √úRET ----------------- */
window.makeSlider = async (CODE)=>{
  const rel = CATEGORY_MAP[CODE]?.related || [];
  let items = [];

  for(const r of rel){
    const l = PRODUCTS[r]?.[0];
    if(!l) continue;
    items.push({link:l, ...(await fetchAPI(l))});
  }

  const html = sliderHTML(CODE, items);
  const blob = new Blob([html],{type:"text/html"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = CODE+".html";
  a.click();
};

/* ----------------- SLIDER TEMPLATE ----------------- */
function sliderHTML(CODE, items){
return `
<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${CODE}</title>
<style>
body{margin:0;font-family:Arial;}
.wrap{position:relative;padding:20px;}
.slider{display:flex;overflow-x:auto;gap:20px;scroll-behavior:smooth;padding-bottom:10px;}
.item{flex:0 0 auto;width:150px;text-align:center;transition:.25s;}
.item img{width:150px;height:150px;object-fit:contain;transition:.25s;}
.item:hover img{transform:scale(1.08);}
.price{color:#c00;font-weight:700;margin-top:4px;}
.stock{color:#d88;font-weight:700;margin-top:4px;font-size:13px;}
.btn{width:130px;padding:8px;margin-top:8px;background:#d54c5a;color:#fff;border-radius:8px;border:0;font-weight:700;cursor:pointer;}
.arrow{position:absolute;top:45%;background:#fff;padding:10px 14px;border-radius:50%;font-size:20px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.25);}
.left{left:10px;} .right{right:10px;}
@media(max-width:600px){.arrow{display:none;}}
</style></head>

<body>
<div class="wrap">
  <div class="arrow left" onclick="document.querySelector('.slider').scrollBy({left:-250,behavior:'smooth'})">‚ùÆ</div>
  <div class="arrow right" onclick="document.querySelector('.slider').scrollBy({left:250,behavior:'smooth'})">‚ùØ</div>

  <div class="slider" id="sld">
    ${items.map(x=>`
      <div class="item">
        <a href="${x.link}" target="_top">
          <img src="${x.image}">
        </a>
        <div>${x.title}</div>
        ${x.stock==="VAR"
          ? `<div class="price">${x.price} ‚Ç∫</div>
             <button class="btn" onclick="parent.location.href='${x.link}?add-to-cart=1'">üõí Sepete Ekle</button>`
          : `<div class="stock">T√ºkendi</div>`
        }
      </div>`).join("")}
  </div>
</div>

<script>
setInterval(()=>{
  const s=document.getElementById("sld");
  s.scrollBy({left:180,behavior:"smooth"});
  if(s.scrollLeft+s.clientWidth>=s.scrollWidth) s.scrollLeft=0;
},1000);
</script>
</body></html>
`;
}

</script>

</body>
</html>
