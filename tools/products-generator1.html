<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Hit-Maker</title>

<style>
body{font-family:Arial;padding:15px;background:#f7f7f7;}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:15px;font-size:13px;}
th,td{border:1px solid #ccc;padding:6px;text-align:left;}
img{width:70px;height:70px;object-fit:contain;}
.red{background:#ffe3e3;}
.btn{padding:5px 10px;border:0;border-radius:5px;cursor:pointer;font-size:12px;}
.update{background:#1976d2;color:#fff}
.gen{background:#ff7f00;color:#fff}
.input{width:150px;padding:4px;margin-right:4px;}
.git{color:#0d47a1;font-weight:bold}
#exportBtn{background:#4caf50;color:#fff;margin-top:15px;font-size:14px;padding:8px 14px;border-radius:6px;}
</style>
</head>
<body>

<h2>Hit-Maker</h2>

<input type="file" id="excelFile" accept=".xlsx">
<button id="exportBtn" onclick="exportExcel()">Excel ÇIKTI AL</button>

<table id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Başlık</th>
  <th>Fiyat</th>
  <th>Kategori</th>
  <th>A-Kodu</th>
  <th>Link</th>
  <th>Slider Üret</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

/* -------------------------- CATEGORY MAP (A01–B12 TAM) -------------------------- */
const CATEGORY_MAP = {
"A01":{"related":["A02","A03","A04","A05","A09","A11","A12","A16","A32","A33","A40","A47","A50","A74","A89"]},
"A02":{"related":["A03","A04","A07","A09","A11","A14","A16","A32","A33","A37","A40","A47","A50","A74","A89"]},
"A03":{"related":["A32","A33","A34","A37","A40","A44","A47","A16","A02","A11","A89","A90","A91","A93","A95"]},
"A04":{"related":["A50","A51","A48","A49","A52","A53","A54","A55","A57","A58","A59","A60","A16","A61","A89"]},
"A05":{"related":["A02","A09","A16","A11","A12","A74","A17","A75","A89","A95","A29","A28","A20","A21","A89"]},
"A06":{"related":["A07","A09","A02","A10","A11","A50","A74","A16","A55","A71","A89","A95","A97","A93","A47"]},
"A07":{"related":["A06","A09","A02","A10","A11","A74","A16","A28","A20","A47","A89","A93","A95","A29","A37"]},
"A08":{"related":["A02","A17","A74","A20","A28","A89","A90","A91","A95","A16","A37","A40","A32","A71","A44"]},
"A09":{"related":["A06","A07","A10","A02","A11","A50","A74","A97","A95","A16","A89","A37","A40","A55","A93"]},
"A10":{"related":["A02","A06","A07","A09","A11","A50","A37","A40","A89","A16","A95","A97","A74","A93","A91"]},
"A11":{"related":["A01","A02","A03","A05","A09","A10","A37","A40","A50","A74","A89","A95","A97","A16","A93"]},
"A12":{"related":["A02","A05","A17","A28","A20","A29","A74","A89","A91","A71","A93","A16","A40","A32","A37"]},
"A13":{"related":["A05","A17","A20","A28","A29","A74","A89","A71","A91","A93","A16","A95","A97","A12","A08"]},
"A14":{"related":["A02","A03","A40","A57","A58","A12","A11","A50","A37","A16","A89","A90","A91","A93","A95"]},
"A15":{"related":["A02","A50","A55","A06","A07","A09","A71","A74","A89","A95","A16","A90","A93","A47","A28"]},
"A16":{"related":["A03","A04","A05","A02","A17","A20","A28","A74","A89","A95","A97","A47","A12","A09","A40"]},
"A17":{"related":["A74","A75","A20","A28","A29","A89","A17","A91","A93","A95","A12","A16","A26","A27","A25"]},
/* ... A18 → A99 ... TAMAMINI EKLEDİNİZ ... */
"B01":{"related":["A17","A18","A19","A20","A28","A89","A93","A16","A95","A22","A23","A25","A26","A27","A21"]},
"B02":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A16","A95","A25","A26","A27","A21","A23"]},
"B03":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A91","A90","A16","A95","A22","A23","A21"]},
"B04":{"related":["B01","A17","A18","A19","A20","A28","A89","A91","A93","A16","A95","A22","A23","A21","A25"]},
"B05":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A91","A16","A95","A24","A23","A21","A25"]},
"B06":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A91","A16","A95","A22","A23","A21","A25"]},
"B07":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A91","A16","A95","A22","A23","A21","A25"]},
"B08":{"related":["A17","A18","A19","A20","A28","A89","A93","A91","A16","A95","A21","A25","A23","A22"]},
"B09":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A91","A16","A95","A21","A22","A23","A24"]},
"B10":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A91","A16","A95","A21","A23","A22","A25"]},
"B11":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A91","A16","A95","A22","A21","A23","A24"]},
"B12":{"related":["B01","A17","A18","A19","A20","A28","A89","A93","A91","A16","A95","A22","A21","A23","A24"]}
};

/* -------------------------- DATA -------------------------- */
let PRODUCTS = {};  
let EXCEL_RAW = [];  

/* -------------------------- EXCEL OKUMA -------------------------- */
document.getElementById("excelFile").addEventListener("change", async (e)=>{
  const f=e.target.files[0];
  const data=await f.arrayBuffer();
  const wb=XLSX.read(data);
  const sheet=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
  EXCEL_RAW = rows;

  const body=document.querySelector("#productTable tbody");
  body.innerHTML="";

  for(let i=1;i<rows.length;i++){
    let cat=rows[i][0];
    let code=rows[i][1];
    let link=rows[i][2];

    if(!code) continue;
    if(!PRODUCTS[code]) PRODUCTS[code]=[];
    if(link) PRODUCTS[code][0]=link;

    let api = link ? await fetchAPI(link) : {title:"-",image:"",price:"-",stock:"YOK",category:"-"};

    body.appendChild(renderRow(i,cat,code,link,api));
  }
});

/* -------------------------- SATIR RENDER -------------------------- */
function renderRow(i,cat,code,link,api){
  const tr=document.createElement("tr");
  if(api.stock==="YOK") tr.classList.add("red");

  tr.innerHTML=`
    <td><img src="${api.image}"></td>
    <td>${api.title}</td>
    <td>${api.price}</td>
    <td>${cat} / API: ${api.category}</td>
    <td>${code}</td>
    <td>
      ${
        api.stock==="YOK"
        ? `
           <input id="inp_${i}" class="input" placeholder="Yeni link">
           <button class="btn update" onclick="updateLink(${i},'${code}')">Güncelle</button>
          `
        : link
          ? `<a class="git" href="${link}" target="_blank">Git</a>`
          : `
             <input id="inp_${i}" class="input" placeholder="Yeni link">
             <button class="btn update" onclick="updateLink(${i},'${code}')">Güncelle</button>
            `
      }
    </td>
    <td><button class="btn gen" onclick="generateSlider('${code}')">Slider Üret</button></td>
  `;
  return tr;
}

/* -------------------------- LİNK GÜNCELLE -------------------------- */
async function updateLink(i,code){
  const newLink=document.getElementById("inp_"+i).value.trim();
  if(!newLink) return;

  PRODUCTS[code]=[newLink];
  const api=await fetchAPI(newLink);

  const row=document.getElementById("inp_"+i).closest("tr");

  row.children[0].innerHTML=`<img src="${api.image}">`;
  row.children[1].innerHTML=api.title;
  row.children[2].innerHTML=api.price;

  const catBase=row.children[3].innerHTML.split("/ API:")[0];
  row.children[3].innerHTML=`${catBase} / API: ${api.category}`;

  if(api.stock==="YOK"){
    row.children[5].innerHTML=`
      <input id="inp_${i}" class="input" placeholder="Yeni link">
      <button class="btn update" onclick="updateLink(${i},'${code}')">Güncelle</button>
    `;
    row.classList.add("red");
  } else {
    row.children[5].innerHTML=`<a href="${newLink}" target="_blank" class="git">Git</a>`;
    row.classList.remove("red");
  }
}

/* -------------------------- API -------------------------- */
async function fetchAPI(url){
  try{
    const r=await fetch("https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url="+encodeURIComponent(url));
    return await r.json();
  }catch{
    return {title:"-",image:"",price:"-",stock:"YOK",category:"-"};
  }
}

/* -------------------------- SLIDER ÜRET -------------------------- */
async function generateSlider(code){
  const rel=CATEGORY_MAP[code]?.related || [];
  let items=[];

  for(const r of rel){
    const link=PRODUCTS[r]?.[0];
    if(!link) continue;

    const api=await fetchAPI(link);
    items.push({...api,link});
    if(items.length>=15) break;
  }

  const html=sliderHTML(items);
  const blob=new Blob([html],{type:"text/html"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=code+"-slider.html";
  a.click();
}

/* -------------------------- SLIDER TEMPLATE -------------------------- */
function sliderHTML(items){
return `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<style>
body{margin:0;padding:0;font-family:Arial;}
.wrap{padding:25px;overflow:hidden;}
.slider{display:flex;gap:18px;overflow-x:auto;padding:10px;}
.slider::-webkit-scrollbar{display:none}
.item{width:170px;height:350px;padding:12px;border-radius:14px;background:#fff;
     box-shadow:0 2px 6px rgba(0,0,0,.12);display:flex;flex-direction:column;text-align:center;cursor:pointer}
.item img{width:150px;height:150px;object-fit:contain;margin:auto;}
.title{font-size:14px;font-weight:700;height:36px;overflow:hidden;
       display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.price{font-size:18px;font-weight:900;color:#c00}
.price.out{color:#bd6b68}
.tukendi{font-size:13px;color:#b69495;font-weight:700}
.btn{padding:8px 0;border-radius:8px;font-weight:700;font-size:13px}
.btn.add{background:#d54c5a;color:#fff}
.btn.disabled{background:#ccc;color:#777}
</style>
</head>
<body>
<div class="wrap">
<div class="slider">
${items.map(p=>`
  <div class="item" onclick="parent.location.href='${p.link}'">
    <img src="${p.image}">
    <div class="title">${p.title}</div>
    ${
      p.stock==="YOK"
      ? `<div class="price out">${p.price}</div><div class="tukendi">Tükendi</div><div class="btn disabled">Sepete Ekle</div>`
      : `<div class="price">${p.price}</div><div class="btn add">Sepete Ekle</div>`
    }
  </div>
`).join("")}
</div>
</div>
</body></html>`;
}

/* -------------------------- EXCEL ÇIKTI AL (GÜNCEL!) -------------------------- */
function exportExcel(){
  let out=[["Kategori","A-Kodu","Link","API Başlık","API Fiyat","API Kategori","Stok"]];

  const rows=document.querySelectorAll("#productTable tbody tr");

  rows.forEach(r=>{
    let img=r.children[0].innerHTML;
    let title=r.children[1].innerText;
    let price=r.children[2].innerText;
    let cat=r.children[3].innerText;
    let code=r.children[4].innerText;

    let linkCell=r.children[5];
    let link="";

    if(linkCell.querySelector("a")) link=linkCell.querySelector("a").href;
    else link="";

    let apiCat = cat.split("/ API: ")[1] || "-";
    let stock = r.classList.contains("red") ? "YOK" : "VAR";

    out.push([cat.split(" / API:")[0],code,link,title,price,apiCat,stock]);
  });

  const ws=XLSX.utils.aoa_to_sheet(out);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Güncel Ürünler");
  XLSX.writeFile(wb,"HitMaker-Güncel.xlsx");
}

</script>

</body>
</html>
