<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>M3 – Minimal Slider Üretici</title>
</head>

<body>

<h3>Excel → Ürünler</h3>

<input type="file" id="excelFile" accept=".xlsx">

<table border="1" id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Başlık</th>
  <th>Fiyat</th>
  <th>A-KODU</th>
  <th>Link</th>
  <th>Güncelle</th>
  <th>Üret</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const CATEGORY_MAP = {
"A01":{"related":["A02","A03","A04","A05","A09","A11","A12","A16","A32","A33","A40","A47","A50","A74","A89"]},
"A02":{"related":["A03","A04","A07","A09","A11","A14","A16","A32","A33","A37","A40","A47","A50","A74","A89"]},
"A03":{"related":["A32","A33","A34","A37","A40","A44","A47","A16","A02","A11","A89","A90","A91","A93","A95"]},
"A04":{"related":["A50","A51","A48","A49","A52","A53","A54","A55","A57","A58","A59","A60","A16","A61","A89"]},
"A05":{"related":["A02","A09","A16","A11","A12","A74","A17","A75","A89","A95","A29","A28","A20","A21","A89"]},
"A06":{"related":["A07","A09","A02","A10","A11","A50","A74","A16","A55","A71","A89","A95","A97","A93","A47"]},
"A07":{"related":["A06","A09","A02","A10","A11","A74","A16","A28","A20","A47","A89","A93","A95","A29","A37"]},
"A08":{"related":["A02","A17","A74","A20","A28","A89","A90","A91","A95","A16","A37","A40","A32","A71","A44"]},
"A09":{"related":["A06","A07","A10","A02","A11","A50","A74","A97","A95","A16","A89","A37","A40","A55","A93"]},
"A10":{"related":["A02","A06","A07","A09","A11","A50","A37","A40","A89","A16","A95","A97","A74","A93","A91"]},
"A11":{"related":["A01","A02","A03","A05","A09","A10","A37","A40","A50","A74","A89","A95","A97","A16","A93"]},
"A12":{"related":["A02","A05","A17","A28","A20","A29","A74","A89","A91","A71","A93","A16","A40","A32","A37"]},
"A13":{"related":["A05","A17","A20","A28","A29","A74","A89","A71","A91","A93","A16","A95","A97","A12","A08"]},
"A14":{"related":["A02","A03","A40","A57","A58","A12","A11","A50","A37","A16","A89","A90","A91","A93","A95"]},
"A15":{"related":["A02","A50","A55","A06","A07","A09","A71","A74","A89","A95","A16","A90","A93","A47","A28"]},
"A16":{"related":["A03","A04","A05","A02","A17","A20","A28","A74","A89","A95","A97","A47","A12","A09","A40"]},
"A17":{"related":["A74","A75","A20","A28","A29","A89","A17","A91","A93","A95","A12","A16","A26","A27","A25"]},
"A18":{"related":["A17","A20","A28","A29","A74","A89","A91","A93","A16","A71","A95","A08","A37","A12","A13"]},
"A19":{"related":["A17","A74","A28","A29","A20","A89","A93","A91","A95","A75","A12","A16","A26","A27","A25"]},
"A20":{"related":["A17","A18","A19","A28","A29","A74","A89","A91","A93","A16","A95","A12","A13","A37","A40"]},
"A21":{"related":["A17","A18","A19","A20","A28","A27","A26","A25","A89","A91","A93","A16","A95","A12","A13"]},
"A22":{"related":["A36","A31","A40","A17","A18","A89","A93","A91","A16","A95","A92","A83","A84","A85","A88"]},
"A23":{"related":["A21","A22","A17","A18","A89","A93","A91","A24","A25","A26","A27","A16","A95","A58","A36"]},
"A24":{"related":["A23","A17","A27","A26","A25","A89","A93","A91","A16","A95","A58","A31","A36","A40","A03"]},
"A25":{"related":["A17","A21","A22","A23","A28","A20","A89","A93","A91","A16","A95","A26","A27","A18","A19"]},
"A26":{"related":["A17","A21","A22","A23","A27","A28","A89","A91","A93","A16","A95","A25","A18","A20","A19"]},
"A27":{"related":["A17","A21","A23","A26","A25","A28","A89","A91","A93","A16","A95","A24","A18","A19","A20"]},
"A28":{"related":["A17","A18","A19","A20","A21","A25","A26","A27","A74","A89","A93","A91","A16","A95","A12"]},
"A29":{"related":["A17","A18","A19","A20","A28","A06","A07","A50","A55","A89","A93","A91","A16","A95","A12"]},
/* ... aynı şekilde A99 ve B01–B12 dahil TAM HARİTA ... */
};

/* GLOBAL */
let PRODUCTS = {};

document.getElementById("excelFile").addEventListener("change", handleExcel);

async function handleExcel(e){
    const file = e.target.files[0];
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const tbody = document.querySelector("#productTable tbody");
    tbody.innerHTML = "";

    for(let i=1;i<rows.length;i++){
        const KATEGORI = rows[i][0];
        const CODE = rows[i][1];
        let LINK = rows[i][2];

        if(!CODE) continue;

        if(!PRODUCTS[CODE]) PRODUCTS[CODE] = [];
        if(LINK) PRODUCTS[CODE][0] = LINK;

        const api = LINK ? await fetchAPI(LINK) : {title:"-",image:"",price:"-",category:"-",stock:"YOK"};

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><img src="${api.image}"></td>
          <td>${api.title}</td>
          <td>${api.price}</td>
          <td>${KATEGORI}<br><b>${api.category}</b></td>
          <td>${CODE}</td>
          <td>${LINK||""}</td>
          <td><button onclick="makeSlider('${CODE}')">ÜRET</button></td>
        `;
        tbody.appendChild(tr);
    }
}

async function fetchAPI(url){
    try{
       const r = await fetch("https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url="+encodeURIComponent(url));
       return await r.json();
    }catch(e){
       return {title:"-",price:"-",image:"",category:"-",stock:"YOK"};
    }
}

async function makeSlider(CODE){
    const rel = CATEGORY_MAP[CODE]?.related || [];
    let items = [];

    for(const r of rel){
        const link = PRODUCTS[r]?.[0];
        if(!link) continue;
        const api = await fetchAPI(link);
        items.push({link,...api});
    }

    const html = sliderHTML(CODE, items);

    const blob = new Blob([html],{type:"text/html"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = CODE+".html";
    a.click();
}

function sliderHTML(CODE, items){
return `
<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${CODE} Slider</title></head>
<body>
<div style="display:flex;overflow-x:auto;gap:20px;padding:20px;">
${items.map(x=>`
<div>
  <a href="${x.link}" target="_top">
    <img src="${x.image}" style="width:150px;height:150px;object-fit:contain;">
  </a>
  <div>${x.title}</div>
  <div>${x.stock==="VAR" ? x.price : "Tükendi"}</div>
</div>
`).join("")}
</div>
</body></html>`;
}
</script>

</body>
</html>
