<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Excel ÃœrÃ¼n GÃ¶rÃ¼ntÃ¼leyici PRO â€“ Ultra Kompakt</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 15px;
  background: #f3f3f3;
}

.box {
  background: white;
  padding: 15px;
  border-radius: 10px;
  max-width: 1100px;
  margin: auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

th, td {
  border: 1px solid #ccc;
  padding: 3px 4px;          /* ðŸ”¥ Ã§ok dar padding */
  font-size: 12px;           /* ðŸ”¥ daha kompakt */
  line-height: 14px;         /* ðŸ”¥ satÄ±rlar dar */
}

th {
  background: #e9e9e9;
  font-weight: bold;
}

img.thumb {
  width: 48px;               /* ðŸ”¥ daha kÃ¼Ã§Ã¼k resim */
  height: 48px;
  object-fit: contain;
  background: #fff;
  border: 1px solid #bbb;
  border-radius: 3px;
}

.cat-small {
  color: #666;
  font-size: 10px;           /* ðŸ”¥ daha kÃ¼Ã§Ã¼k */
}

.stock-ok {
  color: green;
  font-weight: bold;
}

.stock-nok {
  color: red;
  font-weight: bold;
}

input.newLink {
  width: 130px;
  padding: 3px;
  font-size: 11px;
  margin-top: 2px;
}

button.smallBtn {
  padding: 3px 8px;
  font-size: 11px;
  margin-top: 2px;
  cursor: pointer;
}

button.big {
  padding: 8px 15px;
  font-size: 14px;
  margin-top: 10px;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="box">

  <h3>Excel â†’ ÃœrÃ¼n GÃ¶rÃ¼ntÃ¼leme & HIT Ãœretici (Ultra Kompakt)</h3>

  <input type="file" id="excelFile" accept=".xlsx,.xls">
  <button onclick="loadExcel()">YÃ¼kle ve GÃ¶ster</button>
  <button class="big" onclick="generateProducts()">HÄ°TLERÄ° YÃœKLE !</button>

  <div id="status" style="margin-top:8px; font-weight:bold;"></div>

  <table id="productTable" style="display:none;">
    <thead>
      <tr>
        <th>GÃ¶rsel</th>
        <th>ÃœrÃ¼n</th>
        <th>Fiyat</th>
        <th>Kategoriler</th>
        <th>Link / Stok / GÃ¼ncelle</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
let productData = [];
let excelRows = [];

async function loadExcel() {
  const file = document.getElementById("excelFile").files[0];
  if (!file) return alert("Excel seÃ§ilmedi!");

  document.getElementById("status").innerText = "Excel okunuyor...";

  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf);
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

  excelRows = [];

  for (let i = 1; i < rows.length; i++) {
    let catName = rows[i][0];
    let catCode = rows[i][1];
    let link = rows[i][2];

    if (!catName || !catCode || !link) continue;

    excelRows.push({ catName, catCode, link });
  }

  document.getElementById("status").innerText = "ÃœrÃ¼nler alÄ±nÄ±yor...";

  const tbody = document.querySelector("#productTable tbody");
  tbody.innerHTML = "";
  document.getElementById("productTable").style.display = "table";

  productData = [];

  for (let item of excelRows) {
    let d;
    try {
      d = await fetch(
        "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" + encodeURIComponent(item.link)
      ).then(r => r.json());
    } catch {
      d = { title:"Hata", price:"-", stock:"-", image:"", category:"-" };
    }

    productData.push({
      excelCategoryName: item.catName,
      catCode: item.catCode,
      link: item.link,
      title: d.title,
      price: d.price,
      image: d.image,
      stock: d.stock,
      apiCategory: d.category
    });

    let tr = document.createElement("tr");

    tr.innerHTML = `
      <td><img class="thumb" src="${d.image}"></td>

      <td>${d.title.substring(0,55)}...</td>

      <td>${d.price}</td>

      <td>
        <div class="cat-small">API: ${d.category}</div>
        <div class="cat-small">Excel: ${item.catName}</div>
      </td>

      <td>
        <a href="${item.link}" target="_blank">Git</a><br>
        ${
          d.stock === "VAR"
            ? `<span class="stock-ok">VAR</span>`
            : `<span class="stock-nok">YOK</span><br>
               <input class="newLink" placeholder="Yeni link">
               <button class="smallBtn" onclick="updateLink(this)">GÃ¼ncelle</button>`
        }
      </td>
    `;

    tbody.appendChild(tr);
  }

  document.getElementById("status").innerText = "TamamlandÄ±.";
}

// ---------------------------
// LÄ°NK GÃœNCELLEME FONKSÄ°YONU
// ---------------------------
async function updateLink(btn) {
  const tr = btn.closest("tr");
  const input = tr.querySelector("input.newLink");
  const newLink = input.value.trim();
  if (!newLink) return alert("Yeni link boÅŸ!");

  btn.innerText = "Bekleyin...";

  const api =
    "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" + encodeURIComponent(newLink);

  let d = await fetch(api).then(r => r.json());

  // tabloyu gÃ¼ncelle
  tr.children[0].querySelector("img").src = d.image;
  tr.children[1].innerHTML = d.title.substring(0,55) + "...";
  tr.children[2].innerText = d.price;
  tr.children[3].children[0].innerText = "API: " + d.category;

  tr.children[4].innerHTML = `
    <a href="${newLink}" target="_blank">Git</a><br>
    ${
      d.stock === "VAR"
        ? `<span class="stock-ok">VAR</span>`
        : `<span class="stock-nok">YOK</span><br>
           <input class="newLink" placeholder="Yeni link">
           <button class="smallBtn" onclick="updateLink(this)">GÃ¼ncelle</button>`
    }
  `;

  // json da gÃ¼ncelle
  const index = tr.rowIndex - 1;

  productData[index].link = newLink;
  productData[index].title = d.title;
  productData[index].price = d.price;
  productData[index].image = d.image;
  productData[index].stock = d.stock;
  productData[index].apiCategory = d.category;

  btn.innerText = "OK!";
}

// ---------------------------
// HÄ°TLERÄ° YÃœKLE! (products.json Ã¼ret)
// ---------------------------
function generateProducts() {
  if (productData.length === 0) return alert("Excel yÃ¼klemedin!");

  let output = {};

  for (let i = 1; i <= 111; i++) {
    let code = "CAT" + String(i).padStart(3, "0");
    output[code] = [];
  }

  for (let p of productData) {
    if (!output[p.catCode]) output[p.catCode] = [];
    output[p.catCode].push(p.link);
  }

  const blob = new Blob([JSON.stringify(output, null, 2)], {
    type: "application/json"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "products.json";
  a.click();
}
</script>

</body>
</html>
