<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Excel Ürün Görüntüleyici PRO</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 15px;
  background: #f3f3f3;
}

.box {
  background: white;
  padding: 20px;
  border-radius: 10px;
  max-width: 1100px;
  margin: auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 13px;
}

th {
  background: #eee;
  font-weight: bold;
}

img.thumb {
  width: 55px;
  height: 55px;
  object-fit: contain;
  border: 1px solid #ccc;
  border-radius: 3px;
}

.cat-small {
  color: #666;
  font-size: 11px;
}

.stock-ok {
  color: green;
  font-weight: bold;
}

.stock-nok {
  color: red;
  font-weight: bold;
}

input.newLink {
  width: 180px;
  padding: 4px;
  font-size: 12px;
}

button.smallBtn {
  padding: 4px 10px;
  font-size: 12px;
  cursor: pointer;
}

button.big {
  padding: 10px 20px;
  font-size: 15px;
  margin-top: 15px;
}
</style>
</head>

<body>

<div class="box">
  <h2>Excel → Ürün Görüntüleme, Düzenleme ve HIT Üretici</h2>

  <input type="file" id="excelFile" accept=".xlsx,.xls" />
  <button onclick="loadExcel()">Yükle ve Göster</button>
  <button class="big" onclick="generateProducts()">HİTLERİ YÜKLE !</button>

  <div id="status" style="margin-top:10px; font-weight:bold;"></div>

  <table id="productTable" style="display:none;">
    <thead>
      <tr>
        <th>Görsel</th>
        <th>ÜRÜN</th>
        <th>Fiyat</th>
        <th>Stok</th>
        <th>Kategoriler</th>
        <th>Link</th>
        <th>Düzenle (Stok yoksa)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
let productData = []; // tablo + json
let excelRows = [];   // CAT + link veri kaynağı (sıfır hata)

// ------------------------
// EXCEL YÜKLE
// ------------------------
async function loadExcel() {
  const file = document.getElementById("excelFile").files[0];
  if (!file) return alert("Excel seçilmedi!");

  document.getElementById("status").innerText = "Excel okunuyor...";

  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf);
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

  excelRows = [];

  for (let i = 1; i < rows.length; i++) {
    let catName = rows[i][0];
    let catCode = rows[i][1];
    let link = rows[i][2];

    if (!catName || !catCode || !link) continue;

    excelRows.push({ catName, catCode, link });
  }

  document.getElementById("status").innerText = "Ürün bilgileri alınıyor...";

  const tbody = document.querySelector("#productTable tbody");
  tbody.innerHTML = "";
  document.getElementById("productTable").style.display = "table";

  productData = [];

  for (let item of excelRows) {
    let d;

    try {
      d = await fetch(
        "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" + encodeURIComponent(item.link)
      ).then(r => r.json());
    } catch {
      d = { title:"Hata", price:"-", stock:"-", image:"", category:"-" };
    }

    // JSON kaydı
    productData.push({
      excelCategoryName: item.catName,
      catCode: item.catCode,
      link: item.link,
      title: d.title,
      price: d.price,
      image: d.image,
      stock: d.stock,
      apiCategory: d.category
    });

    let tr = document.createElement("tr");

    tr.innerHTML = `
      <td><img class="thumb" src="${d.image}"></td>

      <td>${d.title.substring(0,50)}...</td>

      <td>${d.price}</td>

      <td class="${d.stock === 'VAR' ? 'stock-ok' : 'stock-nok'}">${d.stock}</td>

      <td>
        <div class="cat-small">API: ${d.category}</div>
        <div class="cat-small">Excel: ${item.catName}</div>
      </td>

      <td><a href="${item.link}" target="_blank">Git</a></td>

      <td>
        ${
          d.stock === "YOK"
            ? `<input class="newLink" placeholder="Yeni ürün linki">
               <button class="smallBtn" onclick="updateLink(this)">Güncelle</button>`
            : "-"
        }
      </td>
    `;

    tbody.appendChild(tr);
  }

  document.getElementById("status").innerText = "Tablo hazır.";
}

// ---------------------------
// LİNK GÜNCELLE
// ---------------------------
async function updateLink(btn) {
  const tr = btn.closest("tr");
  const input = tr.querySelector("input.newLink");
  const newLink = input.value.trim();
  if (!newLink) return alert("Yeni ürün linki boş!");

  btn.innerText = "Yükleniyor...";

  const api =
    "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" +
    encodeURIComponent(newLink);

  let d = await fetch(api).then(r => r.json());

  // tabloyu güncelle
  tr.children[0].querySelector("img").src = d.image;
  tr.children[1].innerHTML = d.title.substring(0,50) + "...";
  tr.children[2].innerText = d.price;
  tr.children[3].innerText = d.stock;
  tr.children[3].className = d.stock === "VAR" ? "stock-ok" : "stock-nok";
  tr.children[4].children[0].innerText = "API: " + d.category;
  tr.children[5].querySelector("a").href = newLink;

  // JSON’a işle
  let index = tr.rowIndex - 1;
  productData[index].link = newLink;
  productData[index].title = d.title;
  productData[index].price = d.price;
  productData[index].image = d.image;
  productData[index].stock = d.stock;
  productData[index].apiCategory = d.category;

  btn.innerText = "Güncellendi";
}

// ---------------------------
// HITLERİ YÜKLE → products.json üret
// ---------------------------
function generateProducts() {

  if (productData.length === 0)
    return alert("Önce Excel yükleyin!");

  // products.json yapısı
  let output = {};

  // tüm CAT kodlarını oluştur
  for (let i = 1; i <= 111; i++) {
    let code = "CAT" + String(i).padStart(3, "0");
    output[code] = [];
  }

  // her ürünü CAT alanına otomatik yerleştir
  for (let p of productData) {
    if (!output[p.catCode]) output[p.catCode] = [];
    output[p.catCode].push(p.link);
  }

  // dosya indir
  const blob = new Blob([JSON.stringify(output, null, 2)], {
    type: "application/json"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "products.json";
  a.click();
}
</script>

</body>
</html>
