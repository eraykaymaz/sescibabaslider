<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Excel → Ürün Görüntüleme & HIT Üretici</title>

<style>
body { font-family: Arial; padding: 20px; background: #f5f5f5; }

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  margin-top: 20px;
  font-size: 14px;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
}

.red-row { background: #ffe1e1 !important; }

button {
  padding: 6px 10px;
  font-size: 13px;
  cursor: pointer;
}
.update-btn {
  background: #1976d2;
  color:white;
  border:none;
  border-radius:4px;
  margin-left:5px;
}

.generate-btn {
  background:#28a745;
  color:white;
  padding:10px 16px;
  border-radius:6px;
  border:0;
  margin-top:15px;
}

.link-input {
  width: 95%;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
</style>
</head>

<body>

<h2>Excel → Ürün Görüntüleme & HIT Üretici</h2>

<input type="file" id="excelFile" accept=".xlsx">
<button class="generate-btn" onclick="generateProductsJS()">products.js ÜRET</button>

<table id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Ürün</th>
  <th>Fiyat</th>
  <th>Kategori</th>
  <th>Kategori (API)</th>
  <th>CAT</th>
  <th>Link / Güncelle</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

let PRODUCTS = {};

document.getElementById("excelFile").addEventListener("change", handleExcel);

async function handleExcel(e){
    const file = e.target.files[0];
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const tbody = document.querySelector("#productTable tbody");
    tbody.innerHTML = "";

    for (let i = 1; i < json.length; i++){
        const row = json[i];
        const categoryName = row[0];
        const CAT = row[1];
        let link = row[2];

        if (!CAT) continue;

        if (!PRODUCTS[CAT]) PRODUCTS[CAT] = [];
        if (link) PRODUCTS[CAT].push(link);

        let api = {};
        if (link) {
            api = await fetchAPI(link);
        } else {
            api = { title:"-", image:"", price:"-", category:"-", stock:"YOK" };
        }

        const tr = document.createElement("tr");
        if (api.stock === "YOK") tr.classList.add("red-row");

        tr.innerHTML = `
          <td><img src="${api.image || ""}" width="80"></td>
          <td>${api.title}</td>
          <td>${api.price}</td>
          <td>${categoryName}</td>
          <td>${api.category || "-"}</td>
          <td>${CAT}</td>
          <td id="cell_${i}">
            ${getLinkCellHTML(i, CAT, link)}
          </td>
        `;

        tbody.appendChild(tr);
    }
}

/* Link hücresini oluşturan fonksiyon */
function getLinkCellHTML(i, CAT, link){
    if (!link){
        return `
          <input class="link-input" id="linkInput_${i}" placeholder="Ürün linki gir">
          <button class="update-btn" onclick="updateLink(${i}, '${CAT}')">Kaydet</button>
        `;
    }

    return `
      <a href="${link}" target="_blank">${link}</a><br>
      <input class="link-input" id="linkInput_${i}" value="${link}">
      <button class="update-btn" onclick="updateLink(${i}, '${CAT}')">Güncelle</button>
    `;
}

/* Link güncelleme */
function updateLink(rowIndex, CAT){
    const newLink = document.getElementById("linkInput_"+rowIndex).value.trim();
    if (!newLink) return alert("Lütfen link girin.");

    PRODUCTS[CAT] = [ newLink ];

    document.getElementById("cell_"+rowIndex).innerHTML =
        getLinkCellHTML(rowIndex, CAT, newLink);

    alert("Link güncellendi!");
}

/* API çekme */
async function fetchAPI(url){
    try{
        const r = await fetch(
          "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" + encodeURIComponent(url)
        );
        return await r.json();
    }catch(e){
        return { title:"-", price:"-", image:"", category:"-", stock:"YOK" };
    }
}

/* products.js üret */
function generateProductsJS(){
    const text = "window.PRODUCTS = " + JSON.stringify(PRODUCTS, null, 2) + ";";
    const blob = new Blob([text], { type: "application/javascript" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "products.js";
    a.click();
}

</script>

</body>
</html>
