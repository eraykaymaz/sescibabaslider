<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Excel → Ürün Görüntüleme & HIT Üretici</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; margin:20px; background:#fafafa; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; background:#fff; }
td, th { border:1px solid #ddd; padding:8px; text-align:left; font-size:14px; }
th { background:#f2f2f2; }
img { width:70px; border-radius:6px; }
.red { color:#c40000; font-weight:bold; }
.ok-btn {
  background:#0069d9;
  color:#fff;
  border:0;
  padding:6px 12px;
  border-radius:4px;
  cursor:pointer;
}
.ok-btn:hover { background:#004a9f; }
button { cursor:pointer; }
</style>

</head>
<body>

<h2>Excel → Ürün Görüntüleme & HIT Üretici</h2>

<input type="file" id="excelFile">
<button onclick="exportJS()" style="padding:10px 18px; background:#28a745; color:#fff; border:0; border-radius:4px;">
  products.js Olarak Çıkar
</button>

<table id="table">
<thead>
<tr>
  <th>Görsel</th>
  <th>Ürün</th>
  <th>Fiyat</th>
  <th>Kategori (Excel)</th>
  <th>Kategori (API)</th>
  <th>CAT</th>
  <th>Link / Güncelle</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

let ROWS = [];
let PRODUCTS = {};

document.getElementById("excelFile").addEventListener("change", handleExcel);

async function handleExcel(e) {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = async function(evt) {
        const data = evt.target.result;
        const workbook = XLSX.read(data, {type:'binary'});
        const sheet = workbook.SheetNames[0];
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheet], {header:1});

        rows.shift(); // En üst başlığı atıyoruz
        ROWS = rows;

        const tbody = document.querySelector("#table tbody");
        tbody.innerHTML = "";

        for (let r of rows) {
            const link = r[0];
            const cat = r[1] || "";
            const excelCategory = r[2] || "";

            if (!link) continue;

            const api = await fetchAPI(link);

            // PRODUCTS.js üretimi
            if (!PRODUCTS[cat]) PRODUCTS[cat] = [];
            PRODUCTS[cat].push(link);

            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td><img src="${api.image}"></td>
                <td>${api.title}</td>
                <td>${api.stock === "YOK" ? "<span class='red'>Tükendi</span>" : api.price}</td>
                <td>${excelCategory}</td>
                <td>${api.category}</td>
                <td>${cat}</td>
                <td>
                    <a href="${link}" target="_blank">Git</a>
                    &nbsp;
                    <button class="ok-btn" onclick="updateRow('${link}')">Güncelle</button>
                </td>
            `;

            tbody.appendChild(tr);
        }
    };

    reader.readAsBinaryString(file);
}

async function fetchAPI(url){
    const res = await fetch(
        "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" + encodeURIComponent(url)
    );
    return await res.json();
}

function updateRow(url){
    alert("Güncellendi: " + url);
}

function exportJS() {
    let text = "window.PRODUCTS = " + JSON.stringify(PRODUCTS, null, 2) + ";";

    const blob = new Blob([text], {type: "application/javascript"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "products.js";
    a.click();
}
</script>

</body>
</html>
