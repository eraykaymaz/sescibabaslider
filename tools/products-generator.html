<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Excel → Ürün Görüntüleme & HIT Üretici</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; margin:20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
td, th { border:1px solid #ccc; padding:8px; text-align:left; }
img { width:70px; border-radius:6px; }
button { padding:10px 18px; margin:10px 0; cursor:pointer; }
.red { color:#c30000; font-weight:bold; }
.ok-btn { background:#28a745; color:#fff; border:0; padding:6px 12px; border-radius:4px; cursor:pointer; }
</style>

</head>
<body>

<h2>Excel → Ürün Görüntüleme & HIT Üretici</h2>

<input type="file" id="excelFile">
<button onclick="exportJS()">products.js Olarak Çıkar</button>

<table id="table">
<thead>
<tr>
  <th>Görsel</th>
  <th>Ürün</th>
  <th>Fiyat</th>
  <th>Kategori (Excel)</th>
  <th>Kategori (API)</th>
  <th>CAT</th>
  <th>Link / Güncelle</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

document.getElementById("excelFile").addEventListener("change", handleExcel);

let ROWS = [];     // Excel verisi
let PRODUCTS = {}; // window.PRODUCTS çıktısı için

async function handleExcel(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = async function(evt) {
        const data = evt.target.result;
        const workbook = XLSX.read(data, {type:'binary'});
        const sheet = workbook.SheetNames[0];
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheet], {header:1});

        rows.shift(); // en üst başlığı atıyoruz
        ROWS = rows;

        const tbody = document.querySelector("#table tbody");
        tbody.innerHTML = "";

        for (let r of rows) {
            const link = r[0];
            if (!link) continue;

            const api = await fetchAPI(link);
            const cat = r[1] || "";

            if (!PRODUCTS[cat]) PRODUCTS[cat] = [];
            PRODUCTS[cat].push(link);

            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td><img src="${api.image}"></td>
                <td>${api.title}</td>
                <td>${api.stock === "YOK" ? "<span class='red'>Tükendi</span>" : api.price}</td>
                <td>${r[2] || ""}</td>
                <td>${api.category}</td>
                <td>${cat}</td>
                <td>
                    <a href="${link}" target="_blank">Git</a>
                    &nbsp;
                    <button class="ok-btn" onclick="updateRow('${link}')">Güncelle</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }
    reader.readAsBinaryString(file);
}

async function fetchAPI(url){
    const res = await fetch(
        "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" + encodeURIComponent(url)
    );
    return await res.json();
}

function updateRow(url){
    alert("Güncellendi: " + url);
}

function exportJS() {
    let content = "window.PRODUCTS = " + JSON.stringify(PRODUCTS, null, 2) + ";";
    const blob = new Blob([content], {type:'application/javascript'});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "products.js";
    a.click();
}
</script>

</body>
</html>
