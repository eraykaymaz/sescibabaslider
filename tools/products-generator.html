<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Excel → Ürün Görüntüleme & HIT Üretici</title>

<style>
body { font-family: Arial; padding: 20px; background: #f5f5f5; }

table {
  width: 100%; border-collapse: collapse; margin-top: 20px;
  background: white; font-size: 14px;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
}

.red-row { background: #ffe1e1 !important; }

button {
  padding: 6px 10px;
  font-size: 13px;
  cursor: pointer;
}
.update-btn {
  background: #1976d2;
  color:white;
  border:none;
  border-radius:4px;
}

.generate-btn {
  background:#28a745;
  color:white;
  padding:10px 16px;
  border-radius:6px;
  border:0;
  margin-top:15px;
}
.link-input {
  width: 95%;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
</style>
</head>

<body>

<h2>Excel → Ürün Görüntüleme & HIT Üretici</h2>

<input type="file" id="excelFile" accept=".xlsx">
<button class="generate-btn" onclick="generateProductsJS()">products.js ÜRET</button>

<table id="productTable">
<thead>
<tr>
  <th>Görsel</th>
  <th>Ürün</th>
  <th>Fiyat</th>
  <th>Kategori</th>
  <th>Kategori (API)</th>
  <th>Stok</th>
  <th>CAT</th>
  <th>Link / Güncelle</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

let PRODUCTS = {};  // products.js üretimi için

document.getElementById("excelFile").addEventListener("change", handleExcel);

async function handleExcel(e){
    const file = e.target.files[0];
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const tbody = document.querySelector("#productTable tbody");
    tbody.innerHTML = "";

    for (let i = 1; i < json.length; i++){
        const row = json[i];
        const categoryName = row[0];   // Excel A sütunu
        const CAT = row[1];            // Excel B sütunu
        let link = row[2];             // Excel C sütunu (TABLOYA GİREN LİNK)

        if (!CAT) continue;

        if (!PRODUCTS[CAT]) PRODUCTS[CAT] = [];
        if (link) PRODUCTS[CAT].push(link);

        let api = {};
        if (link){
            api = await fetchAPI(link);
        } else {
            api = { title:"-", image:"", price:"-", category:"-", stock:"-" };
        }

        const tr = document.createElement("tr");
        if (api.stock === "YOK") tr.classList.add("red-row");

        const safeLink = link || "";

        tr.innerHTML = `
          <td><img src="${api.image || ""}" width="80"></td>
          <td>${api.title || "-"}</td>
          <td>${api.price || "-"}</td>
          <td>${categoryName}</td>
          <td>${api.category || "-"}</td>
          <td><b>${api.stock || "-"}</b></td>
          <td>${CAT}</td>
          <td>
            ${safeLink
              ? `<a href="${safeLink}" target="_blank">${safeLink}</a>`
              : `
                 <input class="link-input" id="linkInput_${i}" placeholder="Ürün linki gir">
                 <button class="update-btn" onclick="saveLink(${i}, '${CAT}')">Kaydet</button>
                `
            }
          </td>
        `;

        tbody.appendChild(tr);
    }
}

function saveLink(rowIndex, CAT){
    const val = document.getElementById("linkInput_"+rowIndex).value.trim();
    if (!val) return alert("Lütfen link girin!");

    if (!PRODUCTS[CAT]) PRODUCTS[CAT] = [];
    PRODUCTS[CAT].push(val);

    alert("Link kaydedildi! Yeniden 'products.js ÜRET' yapabilirsin.");
}

function openLink(link){
    if (link) window.open(link, "_blank");
}

async function fetchAPI(url){
    try{
        const r = await fetch(
          "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" + encodeURIComponent(url)
        );
        return await r.json();
    }catch(e){
        return { stock:"-" };
    }
}

/* products.js üret */
function generateProductsJS(){
    let text = "window.PRODUCTS = " + JSON.stringify(PRODUCTS, null, 2) + ";";

    const blob = new Blob([text], { type: "application/javascript" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "products.js";
    a.click();
}

</script>

</body>
</html>

