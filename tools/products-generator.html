<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ürün Görüntüleme & HIT Üretici</title>

<style>
body { font-family: Arial; margin: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 15px; }
td, th { border: 1px solid #ccc; padding: 4px 6px; font-size: 13px; }
th { background: #eee; }
.row-out { background: #ffe5e5 !important; transition: background 0.6s; }
.row-ok { background: #ffffff !important; transition: background 0.6s; }

img { width: 55px; height: 55px; object-fit: contain; }

.link-btn {
    color: #0066cc;
    text-decoration: none;
    font-weight: bold;
}

.update-input {
    width: 160px;
    padding: 3px 5px;
    font-size: 12px;
}

.update-btn {
    padding: 3px 6px;
    font-size: 12px;
    cursor: pointer;
}
</style>

</head>
<body>

<h2>Excel → Ürün Görüntüleme & HIT Üretici</h2>
<input type="file" id="excelFile" accept=".xlsx">

<table id="tb">
<thead>
<tr>
    <th>Resim</th>
    <th>Başlık</th>
    <th>Fiyat</th>
    <th>Kategori</th>
    <th>Link / Güncelle</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="exportProducts()" style="margin-top:20px; padding:10px 18px; font-size:14px;">window.PRODUCTS ÇIKTI AL</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

let PRODUCTS = {}; // güncel ürün listesi buraya dolacak

document.getElementById("excelFile").addEventListener("change", function(e){
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function(ev){
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data, {type:"array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1});

        loadTable(rows);
    };
    reader.readAsArrayBuffer(file);
});

async function fetchData(link){
    try {
        const url = "https://yellow-fog-3fba.eray-kaymaz.workers.dev/?url=" + encodeURIComponent(link);
        const res = await fetch(url);
        return await res.json();
    } catch {
        return null;
    }
}

function loadTable(rows){
    const tbody = document.querySelector("#tb tbody");
    tbody.innerHTML = "";

    // ilk satır başlık → atla
    for (let i = 1; i < rows.length; i++){
        const row = rows[i];
        if (!row || row.length < 2) continue;

        let link = row[1] || "";
        tbody.appendChild(createRow(i, link));
    }
}

function createRow(index, link){
    const tr = document.createElement("tr");

    tr.innerHTML = `
        <td id="img_${index}">–</td>
        <td id="title_${index}">–</td>
        <td id="price_${index}">–</td>
        <td id="cat_${index}">–</td>
        <td id="act_${index}"></td>
    `;

    if (link) {
        tr.classList.add("row-ok");
        loadProduct(index, link);
    } else {
        tr.classList.add("row-out");
        showUpdateField(index);
    }

    return tr;
}

async function loadProduct(index, link){
    const data = await fetchData(link);
    if (!data || !data.title){
        showUpdateField(index);
        return;
    }

    document.getElementById("img_"+index).innerHTML = `<img src="${data.image}">`;
    document.getElementById("title_"+index).innerHTML = data.title;
    document.getElementById("price_"+index).innerHTML = data.price;
    document.getElementById("cat_"+index).innerHTML = data.category;

    // stok kontrolü → stok yoksa güncelleme alanı açılacak
    if (data.stock === "YOK") {
        document.getElementById("act_"+index).innerHTML = ""; 
        showUpdateField(index);
        document.querySelector(`#img_${index}`).closest("tr").classList.remove("row-ok");
        document.querySelector(`#img_${index}`).closest("tr").classList.add("row-out");
    } else {
        // stok varsa sadece GİT
        document.getElementById("act_"+index).innerHTML =
            `<a href="${link}" class="link-btn" target="_blank">Git</a>`;
        document.querySelector(`#img_${index}`).closest("tr").classList.remove("row-out");
        document.querySelector(`#img_${index}`).closest("tr").classList.add("row-ok");
    }

    PRODUCTS["ROW_" + index] = link;
}

function showUpdateField(index){
    document.getElementById("act_"+index).innerHTML = `
        <input class="update-input" id="newLink_${index}" placeholder="Yeni link">
        <button class="update-btn" onclick="updateLink(${index})">Güncelle</button>
    `;
}

async function updateLink(index){
    const newLink = document.getElementById("newLink_"+index).value.trim();
    if (!newLink) return;

    const tr = document.querySelector(`#img_${index}`).closest("tr");

    const data = await fetchData(newLink);
    if (!data || !data.title){
        alert("Linkten veri alınamadı!");
        return;
    }

    // hücreleri yenile
    document.getElementById("img_"+index).innerHTML = `<img src="${data.image}">`;
    document.getElementById("title_"+index).innerHTML = data.title;
    document.getElementById("price_"+index).innerHTML = data.price;
    document.getElementById("cat_"+index).innerHTML = data.category;

    if (data.stock === "YOK") {
        showUpdateField(index);
        tr.classList.add("row-out");
        tr.classList.remove("row-ok");
    } else {
        document.getElementById("act_"+index).innerHTML =
            `<a href="${newLink}" class="link-btn" target="_blank">Git</a>`;
        tr.classList.add("row-ok");
        tr.classList.remove("row-out");
    }

    PRODUCTS["ROW_" + index] = newLink;
}

function exportProducts(){
    let txt = "window.PRODUCTS = {\n";
    for (let k in PRODUCTS){
        txt += `  "${k}": ["${PRODUCTS[k]}"],\n`;
    }
    txt += "};";

    const blob = new Blob([txt], {type:"text/javascript"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "products.js";
    a.click();
}

</script>
</body>
</html>
